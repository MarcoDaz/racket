<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>

  <h1 class="title">Racket</h1>
  <h3>Welcome to Racket</h3>

  <p>Look at all these ridiculous prices!</p>
  <br>
  <a href="/users/new">
    <h3>Want to sign up to create a basket? Click here.</h3>
  </a>

  <form action="/products/search" method="get" onSubmit="searchProducts(event)">
    <input type="text" name="searchTerm" id="searchTerm" placeholder="..Product Name">
    <input type="submit" value="Search" >
  </form>

  <div id="products">
    <% products.forEach(product => { %>
      <h1><%= product.name %></h1>
      <canvas id="<%= product._id %>" width="300" height="300"></canvas>
    <% }) %>
  </div>
   
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="script.js"></script>
  <script>
    const products = <%- JSON.stringify(products) %> 
    products.forEach(product => {createChart(product)});
  </script>
  <script>
    const searchProducts = async (event) => {
      // prevent page from reloading
      event.preventDefault();
      const searchTerm = event.target.searchTerm.value.trim();

      // prevent empty searches
      if (!searchTerm) return;

      const apiUrl = event.target.action;
      const res = await fetch(`${apiUrl}?searchTerm=${searchTerm}`);
      const results = await res.json();

      const productsDiv = document.getElementById("products");
      if (results.length > 0) {
        productsDiv.innerHTML = results.map((product) => {
          return `
            <h1>${product.name}</h1>
            <canvas id="${product._id}" width="300" height="300"></canvas>
          `
        });

        results.forEach(product => {createChart(product)});
      } else {
        productsDiv.innerHTML = "<h1>No products found</h1>"
      }
    }   
  </script>
</body>
</html>

